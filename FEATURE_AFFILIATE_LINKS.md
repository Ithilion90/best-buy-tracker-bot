# Feature: Affiliate Links with Multi-Seller Support

## Implementation Summary

### Objective
All Amazon product links generated by the bot now:
1. Include **affiliate tag** (if configured via `AFFILIATE_TAG` env var)
2. Use **simple `/dp/{ASIN}`** format for maximum reliability
3. Include **user education** hints to check "Other Sellers" for best prices
4. Preserve affiliate tracking through Amazon's redirect system

### Key Discovery
After testing, we found that Amazon **always redirects** `/gp/offer-listing/` URLs back to regular `/dp/` product pages. The offer-listing approach doesn't provide the intended direct access to sorted seller listings. Instead, we use **simple, stable `/dp/` links** combined with **educational hints** to guide users to check "Other Sellers" for the minimum price tracked by the bot.

---

## Changes Made

### 1. Updated `src/utils.py`

#### Simplified `with_affiliate()` Function
```python
def with_affiliate(url: str, use_offer_listing: bool = False) -> str:
    """Add affiliate tag to URL.
    
    Args:
        url: Amazon product URL
        use_offer_listing: Deprecated parameter (kept for backward compatibility)
    
    Returns:
        URL with affiliate tag appended
    
    Note:
        Previously attempted to convert /dp/ â†’ /gp/offer-listing/ but Amazon 
        always redirects back to /dp/ pages. Simple approach is more reliable.
    """
```

**Features:**
- Adds affiliate tag: `?tag={AFFILIATE_TAG}` (or `&tag=` if URL has existing query params)
- Preserves existing query parameters
- Uses `urllib.parse` for proper URL manipulation
- Removed offer-listing conversion (Amazon redirects make it ineffective)

#### New `build_product_url()` Helper
```python
def build_product_url(domain: str, asin: str) -> str:
    """Build simple product URL with affiliate tag.
    
    Args:
        domain: Amazon domain (e.g., 'amazon.it', 'amazon.com')
        asin: Product ASIN identifier
    
    Returns:
        URL to product page with affiliate tag
        Example: https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21
    """
```

**Usage:**
```python
url = build_product_url("amazon.it", "B07RW6Z692")
# â†’ https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21
```

---

### 2. Updated `src/bot.py`

#### Added Import
```python
from src.utils import (
    # ...
    build_product_url,  # Simple /dp/ links with affiliate tags
    # ...
)
```

#### Updated Link Generation (4 locations)

**1. Price Notifications (`send_price_notification`)**
```python
# Build simple product URL with affiliate tag
aff_url = build_product_url(dom, asin)

# Add educational hint to help users find the cheapest seller
seller_hint = "\n\nðŸ’¡ <i>Tip: Check 'Other Sellers' on Amazon for the best price</i>"

# Message includes both the link and the hint
message = f"""
ðŸ”” Price Drop Alert!
...
{aff_url}
{seller_hint}
"""
```

**2. Product Already Tracked Response**
```python
# Use simple product URL
dom_existing = existing_domain or 'amazon.it'
aff_url_existing = build_product_url(dom_existing, existing_asin)
```

**3. Product Added Confirmation**
```python
# Use simple product URL
dom_for_url = domain or 'amazon.it'
aff_url = build_product_url(dom_for_url, asin)
```

**4. Product List (`/list` command)**
```python
# Use simple product URL
dom_for_url = dom or 'amazon.it'
aff_url = build_product_url(dom_for_url, asin)
```

**Key Addition: Educational Hint**
All price notifications now include:
```
ðŸ’¡ Tip: Check 'Other Sellers' on Amazon for the best price
```
This guides users to manually check seller options when the bot has tracked a minimum price from a non-default seller.

---

## URL Examples

### Current Implementation (Simple /dp/ Links)
```
Notification:  https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21
Product List:  https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21
```

### What We Tried (Offer-Listing - Doesn't Work)
```
Attempted:  https://amazon.it/gp/offer-listing/B07RW6Z692?tag=bestbuytracker-21
Result:     Amazon redirects â†’ https://amazon.it/dp/B07RW6Z692?ref=olp-opf-redir&aod=1&tag=bestbuytracker-21
Outcome:    User lands on regular product page anyway (offer-listing approach ineffective)
```

**Key Finding:** Amazon's redirect system makes it impossible to force users to land on the offer-listing page via external links. All `/gp/offer-listing/` URLs redirect to `/dp/` product pages.

---

## User Experience Impact

### Current User Flow (Simple Links + Education)

**What Users See When Clicking Links:**

1. **Receive notification:**
   ```
   ðŸ”¥ HISTORICAL MINIMUM! ðŸ”¥
   
   ðŸ“¦ Corsair VENGEANCE LPX DDR4...
      [Link: https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21]
   
   ðŸ’° New Price: â‚¬99.58
   ðŸ“‰ Historical Min: â‚¬99.58
   
   ï¿½ Tip: Check 'Other Sellers' on Amazon for the best price
   ```

2. **Click link â†’ land on product page**
   - May show different price (e.g., â‚¬109.99 from default seller)
   - Product page includes "Altri venditori" (Other Sellers) link
   - User sees educational hint reminding them to check other sellers

3. **User clicks "Altri venditori" link**
   - Sees all sellers sorted by price:
     ```
     Nuovo (85) da â‚¬99.58
     1. Seller A - â‚¬99.58 â­ (Cheapest)
     2. Seller B - â‚¬102.99
     3. Amazon - â‚¬109.99
     ```

4. **User purchases from cheapest seller**
   - Affiliate commission earned âœ…
   - User gets the â‚¬99.58 price the bot tracked

### Why This Approach Works Better

**Previously Attempted (Offer-Listing Direct Links):**
- âŒ Amazon redirects all `/gp/offer-listing/` to `/dp/` anyway
- âŒ User lands on regular product page despite URL
- âŒ No actual benefit from complex URL manipulation
- âŒ Links appeared "broken" during redirect

**Current Approach (Simple Links + Education):**
- âœ… Direct, stable `/dp/` URLs (no redirects)
- âœ… Links always work correctly
- âœ… Educational hint guides users to "Other Sellers"
- âœ… Bot's tracked price (â‚¬99.58) motivates user to check
- âœ… Simpler implementation, more reliable behavior

---

## Technical Details

### URL Structure

#### Simple Product URL Format
```
https://{domain}/dp/{ASIN}?tag={affiliate_tag}
```

**Components:**
- `/dp/` - Amazon's standard product page endpoint
- `{ASIN}` - Product identifier (e.g., B07RW6Z692)
- `tag={affiliate_tag}` - Affiliate tracking parameter

**Example:**
```
https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21
```

### Query Parameters
- `tag` - Affiliate tag (from `AFFILIATE_TAG` env var)
- Additional parameters preserved if already in URL

### Why Not Offer-Listing URLs?

**Testing Results (5 Different Strategies Tested):**

1. **Strategy: `/gp/offer-listing/{ASIN}`**
   - Result: Redirects to `/dp/{ASIN}?ref=olp-opf-redir&aod=1`
   - Issue: Doesn't land on offer-listing page

2. **Strategy: `/dp/{ASIN}?aod=1`**
   - Result: Redirects to `/dp/{ASIN}` (parameter dropped)
   - Issue: aod parameter doesn't force seller display

3. **Strategy: Various redirect hints**
   - Result: All redirect to standard `/dp/` page
   - Issue: Amazon controls final destination

**Conclusion:** Amazon's redirect system makes it **impossible** to force external links to land on offer-listing pages. The `/gp/offer-listing/` endpoint is for internal Amazon navigation only.

### Affiliate Program Compatibility

**Amazon Associates Requirements:**
- âœ… Tag parameter must be present: `tag={yourTag}`
- âœ… Tag format: typically `{name}-{locale}` (e.g., `bestbuytracker-21`)
- âœ… Works on all Amazon domains (.com, .it, .co.uk, .de, etc.)
- âœ… Commission earned when user purchases within 24h cookie window
- âœ… Works with redirects (tag preserved through redirect chain)

**Link Types Supported:**
- âœ… Direct product links (`/dp/`)
- âœ… Short links (`amzn.to`, `a.co`) - expanded first, then tagged

---

## Configuration

### Environment Variable
```bash
AFFILIATE_TAG=bestbuytracker-21
```

**Required:** Yes (for affiliate commissions)  
**Format:** `{your-name}-{locale-id}`  
**Example:** `bestbuytracker-21` (Italy), `bestbuytracker-20` (US)

**Where to set:**
- Local development: `.env` file
- Docker: `docker run -e AFFILIATE_TAG=...`
- AWS ECS: Task definition environment variables
- EC2: systemd service file or shell environment

### Per-Domain Tags (Future Enhancement)
Currently uses single global tag. Could be enhanced to support:
```python
AFFILIATE_TAGS = {
    'amazon.it': 'mybot-21',
    'amazon.com': 'mybot-20',
    'amazon.de': 'mybot-03',
}
```

---

## Testing

### Test Scripts

**1. `test_revised_url_strategy.py` - Current Implementation**

**Run:**
```bash
python test_revised_url_strategy.py
```

**Test Cases:**
1. âœ… B0DS6S98ZF (amazon.com) - Simple /dp/ link works correctly
2. âœ… B07RW6Z692 (amazon.it) - No redirects, stable URLs
3. âœ… B0F23P3C8B (amazon.com) - Affiliate tag preserved
4. âœ… "Other Sellers" link available on all product pages
5. âœ… All HTTP status 200 OK

**All tests PASSED** âœ…

---

**2. `test_offer_listing_access.py` - Discovery of Redirect Issue**

**What it revealed:**
```
Test Case: https://amazon.it/gp/offer-listing/B07RW6Z692?tag=bestbuytracker-21

Result: HTTP 200 OK
Final URL: https://www.amazon.it/dp/B07RW6Z692/ref=olp-opf-redir?aod=1&tag=bestbuytracker-21

Conclusion: Amazon ALWAYS redirects /gp/offer-listing/ â†’ /dp/
```

This test proved that the offer-listing approach was fundamentally broken due to Amazon's redirect behavior.

---

**3. `test_url_strategies.py` - Comprehensive Strategy Comparison**

**Tested 5 different URL strategies:**
1. Simple `/dp/` with tag
2. `/gp/offer-listing/` with tag  
3. `/dp/` with `?aod=1` parameter
4. Various redirect hints
5. Different parameter combinations

**Result:** All strategies ultimately redirect to `/dp/` product page. Simple approach is most reliable.

---

## Benefits

### For Users
- ðŸ”— **Links always work** (no broken redirects or unexpected destinations)
- âš¡ **Fast, direct access** to product page (no redirect delay)
- ðŸ’¡ **Clear guidance** via educational hint to check "Other Sellers"
- ðŸŽ¯ **Bot's tracked price motivates** user to find the best deal
- âœ… **Transparent experience** (knows what to expect when clicking)

### For Bot Owner
- ðŸ’µ **Affiliate commissions** on all purchases (tag preserved throughout flow)
- ðŸ“Š **Reliable tracking** (simple URLs = consistent behavior)
- ï¿½ï¸ **Lower maintenance** (no complex URL manipulation or redirect handling)
- ðŸ”— **Stable links** (won't break due to Amazon policy changes)

### For Price Tracking Accuracy
- âœ… **Bot tracks true minimum** across all sellers (e.g., â‚¬99.58 from 85 sellers)
- âœ… **User knows to look for it** (hint guides them to "Other Sellers")
- âœ… **Price transparency** (notification shows â‚¬99.58, user can verify)
- âœ… **Trust building** (bot's accuracy + helpful guidance = satisfied users)

### Technical Advantages
- âœ… **Simpler codebase** (less URL manipulation logic)
- âœ… **No redirect handling** (direct `/dp/` URLs work immediately)
- âœ… **Better testability** (predictable URL behavior)
- âœ… **Future-proof** (less dependent on Amazon's internal routing)

---

## Limitations & Design Decisions

### Why Not Direct Seller Links?

**Amazon's URL Constraints:**
- âŒ No stable deep-link URLs for individual sellers' "Add to Cart" buttons
- âŒ Seller IDs are dynamic and not exposed in product pages
- âŒ `/gp/offer-listing/` endpoint always redirects to `/dp/`
- âŒ Cannot force Amazon to display specific seller as default

**What We Tried:**
1. **Offer-listing URLs** (`/gp/offer-listing/{ASIN}`)
   - Amazon redirects â†’ `/dp/{ASIN}?ref=olp-opf-redir&aod=1`
   - User lands on regular product page anyway

2. **Query parameters** (`?aod=1`, `?m=`, etc.)
   - Amazon drops or ignores these parameters
   - No consistent way to influence default seller display

3. **Redirect hints** (various `ref=` values)
   - All variations redirect to standard product page
   - Against Amazon Associates TOS to manipulate URLs excessively

### Current Approach: Simple + Educational

**Why this works better:**
- âœ… **Simple `/dp/` URLs** are stable and always work
- âœ… **Educational hint** guides users: "Check 'Other Sellers' for best price"
- âœ… **Bot's tracked price** (â‚¬99.58) motivates user to investigate
- âœ… **One extra click** to "Altri venditori" is minimal friction
- âœ… **Complies with Amazon Associates guidelines** (clean, simple links)
- âœ… **Affiliate commission earned** when user purchases from any seller

**User Flow:**
```
Notification (â‚¬99.58) â†’ Click Link â†’ Product Page 
â†’ See Hint â†’ Click "Other Sellers" â†’ Find â‚¬99.58 â†’ Purchase
```

**Trade-off Accepted:**
- User needs **one additional click** to see all sellers
- **Benefit:** Reliable, stable links that never break
- **Mitigation:** Educational hint + bot's accurate price tracking

### Future Improvements
1. **A/B test:** Track which products users purchase after clicking links
2. **Enhanced hints:** Show seller name if available (e.g., "Best price from Seller A")
3. **Price anchoring:** Include price in link text: "ðŸ›’ Buy for â‚¬99.58"
4. **Smart routing:** For single-seller products, skip the hint (not needed)


---

## Conclusion

### Implementation Status

âœ… **All product links use simple, reliable `/dp/{ASIN}` format**  
âœ… **Affiliate tags included on all links** (commission tracking active)  
âœ… **Educational hints guide users** to find cheapest seller  
âœ… **Tested and validated** across multiple Amazon domains  
âœ… **Stable behavior** - no broken redirects or unexpected destinations

### Key Learnings

1. **Amazon controls URL behavior** - External links cannot force offer-listing display
2. **Simple is better** - `/dp/` URLs are more reliable than `/gp/offer-listing/` attempts  
3. **Education > Automation** - Guiding users works better than URL manipulation
4. **Affiliate tags persist** - Commissions earned even with redirects

### Final Solution

**Links:**
```
https://amazon.it/dp/B07RW6Z692?tag=bestbuytracker-21
```

**User Guidance:**
```
ðŸ’¡ Tip: Check 'Other Sellers' on Amazon for the best price
```

**Result:** 
- Users get reliable links that always work âœ…
- Bot owner earns affiliate commissions âœ…  
- Bot's accurate price tracking guides users to best deals âœ…
- Simple implementation, minimal maintenance âœ…

**Trade-off:** One extra click to "Other Sellers" is worth the reliability and compliance benefits.

---

*Last updated after testing and revising URL strategy (January 2025)*